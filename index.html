<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试聊天室</title>
    <style>
        :root {
            /* 默认主题色 */
            --primary-color: #6366f1;
            --primary-light: #818cf8;
            --primary-dark: #4f46e5;
            --bg-gradient-start: #ddd6fe;
            --bg-gradient-end: #c7d2fe;
            --border-color: #c4b5fd;
            --focus-ring: rgba(99, 102, 241, 0.1);
            --message-bg: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            --message-shadow: rgba(99, 102, 241, 0.3);
            --button-hover: linear-gradient(135deg, #4338ca 0%, #3730a3 100%);
            --button-shadow: rgba(99, 102, 241, 0.3);
        }

        /* 男友主题 - 蓝色 */
        .theme-boyfriend {
            --primary-color: #3b82f6;
            --primary-light: #60a5fa;
            --primary-dark: #1d4ed8;
            --bg-gradient-start: #dbeafe;
            --bg-gradient-end: #bfdbfe;
            --border-color: #93c5fd;
            --focus-ring: rgba(59, 130, 246, 0.1);
            --message-bg: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            --message-shadow: rgba(59, 130, 246, 0.3);
            --button-hover: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            --button-shadow: rgba(59, 130, 246, 0.3);
        }

        /* 女友主题 - 紫色 */
        .theme-girlfriend {
            --primary-color: #a855f7;
            --primary-light: #c084fc;
            --primary-dark: #7c3aed;
            --bg-gradient-start: #f3e8ff;
            --bg-gradient-end: #e9d5ff;
            --border-color: #d8b4fe;
            --focus-ring: rgba(168, 85, 247, 0.1);
            --message-bg: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%);
            --message-shadow: rgba(168, 85, 247, 0.3);
            --button-hover: linear-gradient(135deg, #7c3aed 0%, #6b21a8 100%);
            --button-shadow: rgba(168, 85, 247, 0.3);
        }

        body { 
            font-family: Arial, sans-serif; 
            max-width: 400px; 
            margin: 0 auto; 
            padding: 20px; 
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            transition: all 0.5s ease;
        }
        
        .container { 
            background: white; 
            border-radius: 15px; 
            padding: 20px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
            transition: all 0.5s ease;
        }
        
        .messages { 
            height: 300px; 
            overflow-y: auto; 
            border: 1px solid var(--border-color); 
            padding: 10px; 
            margin: 10px 0; 
            background: linear-gradient(135deg, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0.4) 100%);
            border-radius: 10px;
            transition: all 0.5s ease;
        }
        
        .input-area { display: flex; gap: 10px; margin-top: 10px; }
        
        input { 
            flex: 1; 
            padding: 10px; 
            border: 2px solid var(--border-color); 
            border-radius: 8px; 
            font-size: 16px;
            transition: all 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--focus-ring);
        }
        
        button { 
            padding: 10px 20px; 
            background: var(--message-bg); 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        button:hover { 
            background: var(--button-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px var(--button-shadow);
        }
        
        .role-button {
            padding: 12px 20px;
            border: 2px solid transparent;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .role-button.boyfriend {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
        }
        
        .role-button.boyfriend:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }
        
        .role-button.girlfriend {
            background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%);
            color: white;
        }
        
        .role-button.girlfriend:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(168, 85, 247, 0.4);
        }
        
        .message { margin: 5px 0; padding: 10px; border-radius: 12px; }
        
        .my-message { 
            background: var(--message-bg); 
            color: white; 
            text-align: right;
            border-radius: 18px 18px 5px 18px;
            box-shadow: 0 2px 8px var(--message-shadow);
        }
        
        .other-message { 
            background: white; 
            color: #374151;
            border: 1px solid #e5e7eb;
            border-radius: 18px 18px 18px 5px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
        }
        
        .system-message { 
            background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%); 
            color: var(--primary-dark); 
            text-align: center; 
            font-size: 14px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .status { 
            text-align: center; 
            font-size: 14px; 
            color: var(--primary-dark); 
            margin: 10px 0;
            font-weight: 500;
        }
        
        .ai-section {
            margin-top: 10px; 
            padding: 12px; 
            background: rgba(255, 255, 255, 0.7); 
            border-radius: 12px; 
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            transition: all 0.5s ease;
        }
        
        .ai-button {
            background: var(--message-bg);
            font-size: 14px; 
            padding: 10px 18px; 
            border: none; 
            border-radius: 8px; 
            color: white; 
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .ai-button:hover {
            background: var(--button-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px var(--button-shadow);
        }
        
        .title-gradient {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="text-align: center; font-weight: 700; font-size: 28px; margin-bottom: 20px;">
            <span style="color: #3b82f6;">💙</span><span style="color: #a855f7;">💜</span> 
            <span class="title-gradient">专属爱情小窝</span>
        </h1>
        
        <!-- 登录区域 -->
        <div id="login">
            <input type="text" id="username" placeholder="输入你的昵称" style="width: 100%; margin-bottom: 15px;">
            <div style="display: flex; gap: 12px; margin-bottom: 15px;">
                <button onclick="login('男友')" class="role-button boyfriend" style="flex: 1;">💙 男友</button>
                <button onclick="login('女友')" class="role-button girlfriend" style="flex: 1;">💜 女友</button>
            </div>
            <div class="status">💕 选择你的身份，进入专属爱情小窝</div>
        </div>
        
        <!-- 聊天区域 -->
        <div id="chat" style="display: none;">
            <div class="status" id="status">等待连接...</div>
            <div class="messages" id="messages"></div>
            <div class="input-area">
                <input type="text" id="messageInput" placeholder="输入消息...">
                <button onclick="sendMessage()">发送</button>
            </div>
            <!-- AI月老助手 -->
            <div class="ai-section">
                <div style="text-align: center; margin-bottom: 8px;">
                    <button onclick="getLoveWords()" class="ai-button">🏹 AI月老</button>
                </div>
                <div id="aiSuggestion" style="display: none; background: white; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); cursor: pointer; transition: all 0.3s;" onclick="copyAISuggestion()">
                    <div style="font-size: 12px; color: var(--primary-dark); margin-bottom: 5px; font-weight: 500;">🏹 AI月老指导 (点击复制到输入框):</div>
                    <div id="aiText" style="color: var(--primary-dark); font-style: italic; font-weight: 500;"></div>
                </div>
            </div>
            
            <div style="margin-top: 10px; text-align: center;">
                <button onclick="clearMessages()" class="ai-button" style="font-size: 14px;">🗑️ 清空聊天</button>
            </div>
            <div class="status" id="syncStatus">🔄 同步状态：就绪</div>
        </div>
    </div>

    <script>
        // 🎯 应用状态
        let app = {
            username: '',
            role: '',
            isLoggedIn: false,
            roomKey: 'mikeyangei_chat_room_v1'
        };

        // 🚪 登录
        function login(role) {
            const username = document.getElementById('username').value.trim();
            if (!username) {
                alert('请输入昵称！');
                return;
            }

            app.username = username;
            app.role = role;
            app.isLoggedIn = true;

            // 🎨 切换主题
            setTheme(role);

            // 切换界面
            document.getElementById('login').style.display = 'none';
            document.getElementById('chat').style.display = 'block';
            
            // 设置状态
            const themeEmoji = role === '男友' ? '💙' : '💜';
            document.getElementById('status').textContent = `${themeEmoji} ${username} (${role}) 已进入爱情小窝`;
            
            // 欢迎消息
            addMessage('系统', `${themeEmoji} 欢迎 ${username} 进入专属爱情小窝！`, 'system');
            addMessage('系统', '💕 开始双人同步聊天...', 'system');
            
            // 开始同步
            startSync();
            
            console.log(`✅ ${username} 登录成功，角色：${role}，主题：${role === '男友' ? '蓝色' : '紫色'}`);
        }

        // 🎨 设置主题
        function setTheme(role) {
            const body = document.body;
            
            // 移除现有主题类
            body.classList.remove('theme-boyfriend', 'theme-girlfriend');
            
            // 添加新主题类
            if (role === '男友') {
                body.classList.add('theme-boyfriend');
                console.log('🎨 切换到男友主题（蓝色）');
            } else {
                body.classList.add('theme-girlfriend');
                console.log('🎨 切换到女友主题（紫色）');
            }
        }

        // 🔄 开始同步
        function startSync() {
            // 立即检查一次
            checkMessages();
            
            // 每2秒检查新消息
            setInterval(checkMessages, 2000);
            
            updateSyncStatus('🟢 同步中');
            console.log('✅ 同步已启动');
        }

        // 📥 检查新消息
        function checkMessages() {
            try {
                const stored = localStorage.getItem(app.roomKey);
                const messages = stored ? JSON.parse(stored) : [];
                
                // 找出不是我发送的新消息
                const newMessages = messages.filter(msg => 
                    msg.sender !== app.username && 
                    !msg.displayed
                );
                
                // 显示新消息
                newMessages.forEach(msg => {
                    addMessage(msg.sender, msg.text, 'other');
                    msg.displayed = true; // 标记为已显示
                });
                
                // 更新存储
                if (newMessages.length > 0) {
                    localStorage.setItem(app.roomKey, JSON.stringify(messages));
                    updateSyncStatus(`🟢 收到 ${newMessages.length} 条新消息`);
                    setTimeout(() => updateSyncStatus('🟢 同步中'), 2000);
                    console.log(`📥 收到 ${newMessages.length} 条新消息`);
                }
                
            } catch (error) {
                console.error('检查消息失败:', error);
                updateSyncStatus('🔴 同步错误');
            }
        }

        // 📤 发送消息
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text || !app.isLoggedIn) return;
            
            // 立即显示我的消息
            addMessage(app.username, text, 'me');
            input.value = '';
            
            // 保存到共享存储
            saveMessage(text);
            
            console.log(`📤 发送消息: ${text}`);
        }

        // 💾 保存消息到共享存储
        function saveMessage(text) {
            try {
                const stored = localStorage.getItem(app.roomKey);
                const messages = stored ? JSON.parse(stored) : [];
                
                const newMessage = {
                    id: Date.now() + Math.random(),
                    sender: app.username,
                    role: app.role,
                    text: text,
                    timestamp: Date.now(),
                    time: new Date().toLocaleString(),
                    displayed: false
                };
                
                messages.push(newMessage);
                
                // 只保留最近50条消息
                if (messages.length > 50) {
                    messages.splice(0, messages.length - 50);
                }
                
                localStorage.setItem(app.roomKey, JSON.stringify(messages));
                updateSyncStatus('🟢 消息已发送');
                
                console.log(`💾 消息已保存: ${text}`);
                
            } catch (error) {
                console.error('保存消息失败:', error);
                updateSyncStatus('🔴 发送失败');
            }
        }

        // 🔧 测试消息
        function testMessage() {
            const input = document.getElementById('messageInput');
            input.value = `🔧 测试消息 ${new Date().toLocaleTimeString()}`;
            sendMessage();
        }

        // 🗑️ 清空消息
        function clearMessages() {
            if (confirm('确定要清空所有消息吗？')) {
                localStorage.removeItem(app.roomKey);
                document.getElementById('messages').innerHTML = '';
                addMessage('系统', '✅ 消息已清空', 'system');
                console.log('🗑️ 消息已清空');
            }
        }

        // 📋 添加消息到界面
        function addMessage(sender, text, type) {
            const container = document.getElementById('messages');
            const time = new Date().toLocaleTimeString();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            
            if (type === 'me') {
                messageDiv.className += ' my-message';
                messageDiv.innerHTML = `${text}<br><small>${time}</small>`;
            } else if (type === 'system') {
                messageDiv.className += ' system-message';
                messageDiv.innerHTML = text;
            } else {
                messageDiv.className += ' other-message';
                messageDiv.innerHTML = `<strong>${sender}:</strong> ${text}<br><small>${time}</small>`;
            }
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // 📊 更新同步状态
        function updateSyncStatus(status) {
            const statusEl = document.getElementById('syncStatus');
            if (statusEl) {
                statusEl.textContent = `🔄 同步状态：${status}`;
            }
        }

        // ⌨️ 回车发送
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (e.target.id === 'username') {
                    // 如果焦点在昵称输入框，自动选择男友角色
                    login('男友');
                } else if (e.target.id === 'messageInput') {
                    sendMessage();
                }
            }
        });

        // 🏹 AI月老功能
        const DEEPSEEK_API_KEY = 'sk-1485e44b18f64bf994b6bde5da7c27f4';
        let currentAISuggestion = '';

        // 🏹 获取AI月老指导
        async function getLoveWords() {
            showAILoading('🏹 AI月老正在分析你们的对话...');
            
            try {
                const timeContext = getTimeContext();
                const roleContext = getRoleContext();
                const chatContext = getChatContext();
                const styleContext = getChatStyleContext();
                const coupleProfile = getCoupleProfile();
                
                console.log('🚀 开始调用DeepSeek API...');
                console.log('API Key:', DEEPSEEK_API_KEY);
                console.log('请求上下文:', roleContext, timeContext);
                console.log('聊天上下文:', chatContext);
                console.log('风格分析:', styleContext);
                console.log('情侣档案:', coupleProfile);
                
                const response = await fetch('https://api.deepseek.com/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${DEEPSEEK_API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [
                            {
                                role: 'system',
                                content: `你是资深AI月老，拥有深度学习情侣沟通的能力。你的专长：

🎯 核心能力：
1. 深度分析对话风格和语言习惯
2. 学习并记忆情侣的喜好、习惯、重要信息
3. 生成符合当事人说话风格的自然建议
4. 根据历史互动优化沟通策略
5. 考虑情感状态、时间场景、关系动态

💬 风格匹配原则：
- 如果对方说话简洁，建议也要简洁有力
- 如果对方喜欢表情包，可建议加入可爱元素
- 如果对方语气温柔，建议语调也要温和
- 如果对方较为活泼，建议可以更有趣味性
- 保持与对话者一贯的表达习惯一致

📚 学习记忆要求：
- 从对话中提取关键信息（喜好、习惯、重要日期等）
- 注意双方的沟通模式和可能的敏感点
- 结合历史档案给出更贴心的建议
- 避免触及过往矛盾或敏感话题

🎭 输出要求：
- 25字以内，自然真挚
- 完全符合当事人的说话风格
- 结合当前情境和历史信息
- 避免生硬的建议，要像朋友的贴心提醒`
                            },
                            {
                                role: 'user',
                                content: `${roleContext}现在是${timeContext}。

📖 最近对话记录：
${chatContext}

🎨 说话风格分析：
${styleContext}

💝 情侣学习档案：
${coupleProfile}

📝 任务要求：
请根据以上所有信息，为我生成一句完全符合我平时说话风格的温暖建议。

重点考虑：
1. 我的语言习惯和表达方式
2. 对方的喜好和敏感点
3. 当前对话的情感状态
4. 历史互动中的成功经验
5. 适合的时间场景

直接输出建议内容，无需解释过程。`
                            }
                        ],
                        max_tokens: 120
                    })
                });
                
                console.log('📡 API响应状态:', response.status);
                
                if (!response.ok) {
                    throw new Error(`API请求失败: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('📄 API响应数据:', data);
                
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    const aiAdvice = data.choices[0].message.content;
                    showAISuggestion(`${aiAdvice} 💕`);
                    console.log('✅ AI月老指导获取成功:', aiAdvice);
                    
                    // 🧠 学习新信息并更新档案
                    updateCoupleProfile(chatContext, aiAdvice);

                } else {
                    throw new Error('API响应格式异常');
                }
                
            } catch (error) {
                console.error('❌ AI请求失败:', error);
                
                // 显示详细错误信息
                addMessage('系统', `❌ AI月老连线失败: ${error.message}`, 'system');
                addMessage('系统', '🔄 使用智能备用建议...', 'system');
                
                const fallbackWords = getContextualFallbackWords();
                showAISuggestion(fallbackWords);
                console.log('🔄 使用上下文备用建议:', fallbackWords);
            }
        }

        // 🎨 获取聊天风格分析
        function getChatStyleContext() {
            try {
                const stored = localStorage.getItem(app.roomKey);
                const messages = stored ? JSON.parse(stored) : [];
                
                // 分析我的说话风格
                const myMessages = messages
                    .filter(msg => msg.sender === app.username)
                    .map(msg => msg.text)
                    .slice(-10); // 最近10条消息
                
                // 分析对方的说话风格
                const partnerMessages = messages
                    .filter(msg => msg.sender !== app.username && msg.sender !== '系统')
                    .map(msg => msg.text)
                    .slice(-10);
                
                if (myMessages.length === 0) {
                    return '暂无足够的聊天记录进行风格分析。';
                }
                
                // 分析我的风格特征
                const myStyleAnalysis = analyzeTextStyle(myMessages, '我');
                
                // 分析对方的风格特征  
                const partnerStyleAnalysis = partnerMessages.length > 0 
                    ? analyzeTextStyle(partnerMessages, '对方')
                    : '对方还未发言，无法分析风格';
                
                return `我的说话风格：${myStyleAnalysis}

对方的说话风格：${partnerStyleAnalysis}

风格匹配建议：请生成符合我平时表达习惯的建议，同时考虑对方的接受风格。`;
                
            } catch (error) {
                console.error('风格分析失败:', error);
                return '无法进行风格分析，请根据常规情侣沟通方式给出建议。';
            }
        }

        // 🔍 分析文本风格
        function analyzeTextStyle(messages, who) {
            if (messages.length === 0) return `${who}暂无发言记录`;
            
            const text = messages.join(' ');
            const features = [];
            
            // 长度分析
            const avgLength = text.length / messages.length;
            if (avgLength < 10) features.push('简洁型');
            else if (avgLength > 30) features.push('详细型');
            else features.push('适中型');
            
            // 表情分析
            if (text.includes('😊') || text.includes('😄') || text.includes('🥰')) features.push('爱用开心表情');
            if (text.includes('💕') || text.includes('❤️') || text.includes('💖')) features.push('爱用爱心表情');
            if (text.match(/[😂🤣😅]/)) features.push('幽默风趣');
            
            // 语气分析
            if (text.includes('哈哈') || text.includes('嘻嘻')) features.push('活泼开朗');
            if (text.includes('哦') || text.includes('嗯嗯')) features.push('温和回应');
            if (text.includes('呀') || text.includes('呢') || text.includes('哇')) features.push('语气可爱');
            if (text.includes('！') || text.includes('!')) features.push('表达热情');
            
            // 内容倾向
            if (text.includes('工作') || text.includes('忙')) features.push('关注日常');
            if (text.includes('想你') || text.includes('爱你')) features.push('情感直接');
            if (text.includes('累') || text.includes('辛苦')) features.push('互相关心');
            
            return features.length > 0 ? features.join('、') : '表达自然';
        }

        // 💝 获取情侣档案
        function getCoupleProfile() {
            try {
                const profileKey = `couple_profile_${app.roomKey}`;
                const stored = localStorage.getItem(profileKey);
                const profile = stored ? JSON.parse(stored) : {
                    创建时间: new Date().toISOString(),
                    双方信息: {},
                    重要日期: {},
                    喜好记录: {},
                    沟通模式: {},
                    敏感话题: [],
                    成功经验: [],
                    互动统计: {
                        总消息数: 0,
                        AI建议使用次数: 0,
                        最后更新: new Date().toISOString()
                    }
                };
                
                if (Object.keys(profile.双方信息).length === 0) {
                    return '🆕 这是你们的第一次AI月老咨询，开始建立专属情侣档案...';
                }
                
                return `📊 专属情侣档案（自动学习更新）：

👫 双方信息：
${JSON.stringify(profile.双方信息, null, 2)}

📅 重要日期：
${JSON.stringify(profile.重要日期, null, 2)}

💝 喜好记录：
${JSON.stringify(profile.喜好记录, null, 2)}

💬 沟通模式：
${JSON.stringify(profile.沟通模式, null, 2)}

⚠️ 敏感话题：${profile.敏感话题.join('、') || '暂无'}

✅ 成功经验：${profile.成功经验.slice(-3).join('；') || '正在积累...'}

📈 互动统计：AI建议已使用${profile.互动统计.AI建议使用次数}次`;
                
            } catch (error) {
                console.error('获取情侣档案失败:', error);
                return '📝 正在初始化专属情侣档案系统...';
            }
        }

        // 📚 更新情侣档案
        function updateCoupleProfile(chatContext, aiAdvice) {
            try {
                const profileKey = `couple_profile_${app.roomKey}`;
                const stored = localStorage.getItem(profileKey);
                let profile = stored ? JSON.parse(stored) : {
                    创建时间: new Date().toISOString(),
                    双方信息: {},
                    重要日期: {},
                    喜好记录: {},
                    沟通模式: {},
                    敏感话题: [],
                    成功经验: [],
                    互动统计: {
                        总消息数: 0,
                        AI建议使用次数: 0,
                        最后更新: new Date().toISOString()
                    }
                };
                
                // 更新基础信息
                profile.双方信息[app.username] = app.role;
                profile.互动统计.AI建议使用次数++;
                profile.互动统计.最后更新 = new Date().toISOString();
                
                // 从聊天内容中提取信息
                extractInfoFromChat(profile, chatContext);
                
                // 记录成功的AI建议
                if (aiAdvice) {
                    profile.成功经验.push(`${new Date().toLocaleDateString()}: ${aiAdvice}`);
                    if (profile.成功经验.length > 10) {
                        profile.成功经验 = profile.成功经验.slice(-10); // 只保留最近10条
                    }
                }
                
                // 保存档案
                localStorage.setItem(profileKey, JSON.stringify(profile));
                console.log('📚 情侣档案已更新:', profile);
                
            } catch (error) {
                console.error('更新情侣档案失败:', error);
            }
        }

        // 🔍 从聊天中提取信息
        function extractInfoFromChat(profile, chatContext) {
            const text = chatContext.toLowerCase();
            
            // 提取时间相关信息
            if (text.includes('生日') || text.includes('birthday')) {
                if (!profile.重要日期.生日) profile.重要日期.生日 = '提及过生日话题';
            }
            if (text.includes('纪念日') || text.includes('anniversary')) {
                if (!profile.重要日期.纪念日) profile.重要日期.纪念日 = '提及过纪念日话题';
            }
            if (text.includes('节日') || text.includes('假期')) {
                if (!profile.重要日期.节日计划) profile.重要日期.节日计划 = '讨论过节日安排';
            }
            
            // 提取喜好信息
            if (text.includes('喜欢') || text.includes('爱好')) {
                const lines = chatContext.split('\n');
                lines.forEach(line => {
                    if (line.includes('喜欢')) {
                        const parts = line.split('喜欢');
                        if (parts.length > 1) {
                            const preference = parts[1].substring(0, 20);
                            profile.喜好记录[`${app.username}的喜好`] = preference;
                        }
                    }
                });
            }
            
            // 分析沟通模式
            const stored = localStorage.getItem(app.roomKey);
            if (stored) {
                const messages = JSON.parse(stored);
                const myMessages = messages.filter(msg => msg.sender === app.username).length;
                const totalMessages = messages.filter(msg => msg.sender !== '系统').length;
                
                if (totalMessages > 0) {
                    const myRatio = (myMessages / totalMessages * 100).toFixed(1);
                    profile.沟通模式[`${app.username}发言占比`] = `${myRatio}%`;
                }
            }
            
            // 检测可能的敏感话题
            if (text.includes('吵架') || text.includes('生气') || text.includes('不开心')) {
                const sensitiveKeyword = '情绪波动话题';
                if (!profile.敏感话题.includes(sensitiveKeyword)) {
                    profile.敏感话题.push(sensitiveKeyword);
                }
            }
        }

        // 📖 获取聊天上下文
        function getChatContext() {
            try {
                const stored = localStorage.getItem(app.roomKey);
                const messages = stored ? JSON.parse(stored) : [];
                
                // 获取最近的5条真实聊天消息（排除系统消息）
                const recentMessages = messages
                    .filter(msg => msg.sender && msg.sender !== '系统')
                    .slice(-5)
                    .map(msg => `${msg.sender}: ${msg.text}`)
                    .join('\n');
                
                if (!recentMessages) {
                    return `当前还没有开始对话，这是你们在专属爱情小窝的第一次交流。`;
                }
                
                // 分析对话情况
                const myMessages = messages.filter(msg => msg.sender === app.username).length;
                const partnerMessages = messages.filter(msg => msg.sender !== app.username && msg.sender !== '系统').length;
                
                let contextAnalysis = '';
                if (myMessages === 0 && partnerMessages === 0) {
                    contextAnalysis = '刚进入聊天室，还没有开始对话。';
                } else if (partnerMessages === 0) {
                    contextAnalysis = '对方还没有回复，可能需要一个温暖的开场。';
                } else if (myMessages > partnerMessages) {
                    contextAnalysis = '我说话比较多，可能需要给对方更多表达机会。';
                } else {
                    contextAnalysis = '双方都在积极交流，对话氛围良好。';
                }
                
                return `对话状态：${contextAnalysis}

最近的聊天记录：
${recentMessages || '暂无对话记录'}

我的角色：${app.role}
我的昵称：${app.username}`;
                
            } catch (error) {
                console.error('获取聊天上下文失败:', error);
                return '暂时无法分析聊天记录，建议发送一句温暖的问候。';
            }
        }

        // 💕 智能备用建议（基于上下文）
        function getContextualFallbackWords() {
            const timeContext = getTimeContext();
            const chatContext = getChatContext();
            
            // 根据对话状态和时间生成建议
            if (chatContext.includes('还没有开始对话') || chatContext.includes('暂无对话记录')) {
                // 开场建议
                const openingWords = app.role === '男友' ? [
                    `${timeContext}好！今天过得怎么样？`,
                    '刚进来就想跟你聊天，想你了',
                    `${timeContext}了，在忙什么呢？`
                ] : [
                    `${timeContext}好！看到你在线好开心`,
                    '进来了！今天有什么有趣的事吗？',
                    `${timeContext}了，想和你聊聊天`
                ];
                return openingWords[Math.floor(Math.random() * openingWords.length)];
            } else if (chatContext.includes('还没有回复')) {
                // 等待回复的建议
                const waitingWords = app.role === '男友' ? [
                    '发个可爱的表情包吧，逗她开心',
                    '问问她在忙什么，表达关心',
                    '分享你今天的小趣事'
                ] : [
                    '夸夸他的话题很有趣',
                    '问他需要帮助吗，很贴心',
                    '分享你的感受，让他了解你'
                ];
                return waitingWords[Math.floor(Math.random() * waitingWords.length)];
            } else {
                // 正常对话的建议
                return getFallbackLoveWords();
            }
        }

        // 💕 备用情话
        function getFallbackLoveWords() {
            const timeContext = getTimeContext();
            const morningWords = app.role === '男友' ? 
                ['早安，希望你今天也像阳光一样灿烂', '新的一天开始了，想和你分享每个美好时刻'] :
                ['早安，愿你今天工作顺利，我会想你的', '新的一天开始了，你是我最温暖的动力'];
                
            const afternoonWords = app.role === '男友' ? 
                ['下午好，希望你没有太累，记得照顾自己', '忙碌的下午，但想到你就很开心'] :
                ['下午好，工作辛苦了，你一直很努力很棒', '下午时光，有你在心里就很温暖'];
                
            const eveningWords = app.role === '男友' ? 
                ['晚上了，今天过得怎么样？想听你分享', '夜晚降临，你是我心中最亮的星'] :
                ['晚上好，今天辛苦了，有你真的很幸福', '夜晚时分，想对你说一声谢谢'];
                
            let words;
            if (timeContext === '早上' || timeContext === '上午') words = morningWords;
            else if (timeContext === '下午' || timeContext === '中午') words = afternoonWords;
            else words = eveningWords;
            
            return words[Math.floor(Math.random() * words.length)];
        }

        // 🕐 获取时间上下文
        function getTimeContext() {
            const hour = new Date().getHours();
            if (hour >= 6 && hour < 9) return '早上';
            if (hour >= 9 && hour < 12) return '上午';
            if (hour >= 12 && hour < 14) return '中午';
            if (hour >= 14 && hour < 18) return '下午';
            if (hour >= 18 && hour < 22) return '晚上';
            return '深夜';
        }

        // 👫 获取角色上下文
        function getRoleContext() {
            const myRole = app.role;
            const partnerRole = app.role === '男友' ? '女友' : '男友';
            return `我是${myRole}，想要对我的${partnerRole}说一句情话。`;
        }

        // 📋 显示AI建议
        function showAISuggestion(text) {
            currentAISuggestion = text;
            const suggestionDiv = document.getElementById('aiSuggestion');
            const textDiv = document.getElementById('aiText');
            
            textDiv.textContent = text;
            suggestionDiv.style.display = 'block';
            suggestionDiv.style.background = '#e8f5e8';
            suggestionDiv.style.borderColor = '#28a745';
            
            // 添加复制提示动画
            setTimeout(() => {
                suggestionDiv.style.background = 'white';
                suggestionDiv.style.borderColor = '#dee2e6';
            }, 1000);
            
            console.log('💡 AI建议显示:', text);
        }

        // ⏳ 显示AI加载状态
        function showAILoading(message) {
            const suggestionDiv = document.getElementById('aiSuggestion');
            const textDiv = document.getElementById('aiText');
            
            textDiv.textContent = message;
            suggestionDiv.style.display = 'block';
            suggestionDiv.style.background = '#f8f9fa';
            suggestionDiv.style.borderColor = '#6c757d';
        }

        // 📋 复制AI建议到输入框
        function copyAISuggestion() {
            if (!currentAISuggestion) return;
            
            const input = document.getElementById('messageInput');
            input.value = currentAISuggestion;
            input.focus();
            
            // 视觉反馈
            const suggestionDiv = document.getElementById('aiSuggestion');
            suggestionDiv.style.background = '#d1ecf1';
            suggestionDiv.style.borderColor = '#17a2b8';
            
            setTimeout(() => {
                suggestionDiv.style.background = 'white';
                suggestionDiv.style.borderColor = '#dee2e6';
            }, 500);
            

            console.log('📋 AI建议已复制:', currentAISuggestion);
        }

        console.log('✅ AI聊天室已加载 - 版本3.0');
        console.log('🔗 使用房间:', app.roomKey);
        console.log('🤖 DeepSeek AI助手已就绪');
    </script>
</body>
</html>
